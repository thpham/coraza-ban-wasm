# GitHub Actions workflow for building and releasing coraza-ban-wasm
#
# WASM is architecture-independent (runs in V8/wasmtime VM),
# so multi-arch builds are NOT needed.
#
# Triggers:
# - Every push to main: build
# - Every PR to main: build
# - Version tags (v*): build and publish OCI artifact

name: Build and Release WASM

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: go.sum

      - name: Setup TinyGo
        uses: acifani/setup-tinygo@v2
        with:
          tinygo-version: "0.36.0"

      - name: Download dependencies
        run: go mod download

      - name: Build WASM
        run: |
          cd wasm
          tinygo build -o ../coraza-ban-wasm.wasm \
            -target=wasi \
            -scheduler=none \
            -no-debug \
            .

      - name: Show artifact info
        run: |
          ls -lh coraza-ban-wasm.wasm
          file coraza-ban-wasm.wasm

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: coraza-ban-wasm
          path: coraza-ban-wasm.wasm
          retention-days: 1

  release:
    name: Release OCI Artifact
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: coraza-ban-wasm

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Push OCI artifact (versioned)
        run: |
          oras push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            --artifact-type application/vnd.module.wasm.content.layer.v1+wasm \
            coraza-ban-wasm.wasm:application/wasm

      - name: Push OCI artifact (latest)
        run: |
          oras push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --artifact-type application/vnd.module.wasm.content.layer.v1+wasm \
            coraza-ban-wasm.wasm:application/wasm

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OCI URLs**:" >> $GITHUB_STEP_SUMMARY
          echo "- \`oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Usage in Istio**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "apiVersion: extensions.istio.io/v1alpha1" >> $GITHUB_STEP_SUMMARY
          echo "kind: WasmPlugin" >> $GITHUB_STEP_SUMMARY
          echo "spec:" >> $GITHUB_STEP_SUMMARY
          echo "  url: oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
